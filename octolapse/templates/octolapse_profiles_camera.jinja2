<!--
##################################################################################
# Octolapse - A plugin for OctoPrint used for making stabilized timelapse videos.
# Copyright (C) 2017  Brad Hochgesang
##################################################################################
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see the following:
# https://github.com/FormerLurker/Octolapse/blob/master/LICENSE
#
# You can contact the author either through the git-hub repository, or at the
# following email address: FormerLurker@pm.me
##################################################################################
-->
<script type="text/html" id="camera-template">
    <input type="hidden" data-bind="value : guid" />
    <div>
        <div>
            <h4>Profile</h4>
        </div>
        <div class="control-group">
            <label class="control-label">Name</label>
            <div class="controls">
                <input id="camera_profile_name" name="name" type="text" class="input-block-level" data-bind="value: name" required="true" />
                <div class="error_label_container text-error" data-error-for="camera_profile_name"></div>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Description</label>
            <div class="controls">
                <textarea id="camera_profile_description" name="description" type="text" class="input-block-level" data-bind="value: description" maxlength="1024" />
                <div class="error_label_container text-error" data-error-for="camera_profile_description"></div>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Enabled</label>
            <div class="controls">
                <label class="checkbox">
                    <input type="checkbox" data-bind="checked: enabled" />Enabled
                </label>
                <span class="help-inline">Octolapse will only acquire images from this camera if it is enabled.</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Camera Type</label>
            <div class="controls">
                <select id="camera_profile_camera_type" name="camera_type" data-bind="options: Octolapse.Cameras.profileOptions.camera_type_options,
                             optionsText: 'name',
                             optionsValue: 'value',
                             optionsCaption: 'Select One...',
                             value: camera_type"></select>
                <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#camera-types" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                <div class="error_label_container text-error" data-error-for="camera_profile_camera_type"></div>
            </div>
        </div>
    </div>
    <hr />

    <div data-bind="visible: camera_type() == 'external-script'">
        <div>
            <h4>External Camera Setup - Script</h4>
        </div>
        <div class="control-group">
            <label class="control-label">Snapshot Acquire Script</label>
            <div class="controls">
                <input id="camera_profile_external_camera_snapshot_script" name="external_camera_snapshot_script" type="text" class="input-xlg ignore_hidden_errors" data-bind="value: external_camera_snapshot_script" required="true" />
                <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#snapshot-acquire-script" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                <div class="error_label_container text-error" data-error-for="camera_profile_external_camera_snapshot_script"></div>

                <span class="help-inline">The full path and file name of a script that will be run executed after the printer is in the stabilization position.  Should be used to take a snapshot.</span>
            </div>
        </div>
    </div>

    <div data-bind="visible: camera_type() == 'printer-gcode'">
        <div>
            <h4>Gcode Script Camera - Send gcode to your printer to take a snapshot</h4>
        </div>
        <div class="control-group">
            <label class="control-label">Gcode</label>
            <div class="controls">
                <textarea id="camera_profile_gcode_camera_script" name="gcode_camera_script" type="text" class="input-xlg ignore_hidden_errors" data-bind="value: gcode_camera_script" required="true" />
                <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#gcode" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                <div class="error_label_container text-error" data-error-for="camera_profile_gcode_camera_script"></div>
                <span class="help-inline">Gcode to send to the printer in order to capture a snapshot.</span>
            </div>
        </div>
    </div>
    <div data-bind="visible: camera_type() == 'webcam'">
        <div>
            <h4>Webcam Setup</h4>
        </div>
        <div class="control-group">
            <label class="control-label">Base Address</label>
            <div class="controls">
                <input id="camera_profile_address" type="text" name="address" class="input-xxl ignore_hidden_errors" data-bind="value: webcam_settings.address" required="true" />
                <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#base-address" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                <div class="error_label_container text-error" data-error-for="camera_profile_address"></div>
                <span class="help-inline">The full address to the camera, including http:// or https://</span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Snapshot Address Template</label>
            <div class="controls">
                <input id="camera_profile_snapshot_request_template" name="snapshot_request_template" type="text" class="input-xxl ignore_hidden_errors" data-bind="value: webcam_settings.snapshot_request_template" required="true" />
                <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#snapshot-address-template" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                <button class="btn btn-default input-xxl" data-bind="click: function() {$data.testCamera();}">Test</button>
                <div class="error_label_container text-error" data-error-for="camera_profile_snapshot_request_template"></div>
                <span class="help-inline">
                    Enter a full url for accessing a snapshot image from your webcam.  The token <i>{camera_address}</i> will be replaced with the camera address above.
                </span>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Stream Address Template</label>
            <div class="controls">
                <input id="camera_profile_stream_template" name="stream_template" type="text" class="input-xxl ignore_hidden_errors" data-bind="value: webcam_settings.stream_template" required="true" />
                <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#stream-template" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                <div class="error_label_container text-error" data-error-for="camera_profile_stream_template"></div>
                <span class="help-inline">
                    This is ONLY used for previewing webcam custom image preferences.
                </span>
            </div>
        </div>
    </div>
    <div>
        <h4>General Options</h4>
    </div>
    <div class="control-group">
        <label class="control-label">Snapshot Delay</label>
        <div class="controls">
            <span class="input-append">
                <input id="camera_profile_delay" name="delay" type="number" class="input-small text-right" data-bind="value: delay" min="0" max="5000" step="1" required="true" />
                <span class="add-on">MS</span>
            </span>
            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#snapshot-delay" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
            <div class="error_label_container text-error" data-error-for="camera_profile_delay"></div>
            <span class="help-inline">Applied before taking a snapshot.  Use higher values if you encounter motion blur, but consider changing to manual focus/manual exposure/manual white balance in the Image Preferences below.  This can reduce the required delay substantially.  The optimal value = 1000/FPS.  Example for 30FPS:  1000/30FPS = 33.3</span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Snapshot Timeout</label>
        <div class="controls">
            <span class="input-append">
                <input id="camera_profile_timeout_ms" name="timeout_ms" type="number" class="input-small text-right" data-bind="value: timeout_ms" min="0" max="25000" step="1" required="true" />
                <span class="add-on">MS</span>
            </span>
            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#snapshot-timeout" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
            <div class="error_label_container text-error" data-error-for="camera_profile_timeout_ms"></div>
            <span class="help-inline">If an image takes longer than the allowed time (in milliseconds) to acquire, it will timeout and the print will continue.</span>
        </div>
    </div>
    <div class="control-group" data-bind="visible: camera_type() != 'printer-gcode'">
        <label class="control-label">Snapshot Transposition Options</label>
        <div class="controls">
            <select id="camera_profile_snapshot_transpose" data-bind="options: Octolapse.Cameras.profileOptions.snapshot_transpose_options,
                             optionsText: 'name',
                             optionsValue: 'value',
                             optionsCaption: 'Select One...',
                             value: snapshot_transpose"></select>
            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#snapshot-transposition-options" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
            <div class="error_label_container text-error" data-error-for="camera_profile_snapshot_transpose"></div>
            <span class="help-inline">Beta Feature - Optionally rotate, mirror, or flip or transpose your snapshots.  Requires some additional power from your CPU.  Not recommended for slower hardware.</span>
        </div>
    </div>
    <div>
        <h4>Custom Camera Scripts</h4>
    </div>
    <hr />
    <div class="control-group">
        <label class="control-label">Before Print Start Script</label>
        <div class="controls">
            <input id="camera_profile_on_print_start_script" name="on_print_start_script" type="text" class="input-xlg ignore_hidden_errors" data-bind="value: on_print_start_script" />
            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#before-print-start-script" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
            <button class="btn btn-default " data-bind="click: function() {$data.applySettingsToCamera('script');}">Test Script</button>
            <div class="error_label_container text-error" data-error-for="camera_profile_on_print_start_script"></div>
            <span class="help-inline">Octolapse will execute any script path entered here at the start of a print.</span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Before Snapshot Script</label>
        <div class="controls">
            <input id="camera_profile_on_before_snapshot_script" name="on_before_snapshot_script" type="text" class="input-xlg ignore_hidden_errors" data-bind="value: on_before_snapshot_script" />
            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#before-snapshot-script" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
            <div class="error_label_container text-error" data-error-for="camera_profile_on_before_snapshot_script"></div>
            <span class="help-inline">Octolapse will execute any script path entered here after the printer has stabilized but before taking a snapshot.</span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">After Snapshot Script</label>
        <div class="controls">
            <input id="camera_profile_on_after_snapshot_script" name="on_after_snapshot_script" type="text" class="input-xlg ignore_hidden_errors" data-bind="value: on_after_snapshot_script" />
            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#after-snapshot-script" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
            <div class="error_label_container text-error" data-error-for="camera_profile_on_after_snapshot_script"></div>
            <span class="help-inline">Octolapse will execute any script path entered here after a snapshot is complete.</span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Before Render Script</label>
        <div class="controls">
            <input id="camera_profile_on_before_render_script" name="on_before_render_script" type="text" class="input-xlg ignore_hidden_errors" data-bind="value: on_before_render_script" />
            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#before-render-script" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
            <div class="error_label_container text-error" data-error-for="camera_profile_on_before_render_script"></div>
            <span class="help-inline">Octolapse will execute any script path entered here right before rendering.  This is useful to transfer images from a remote location (DSLR or printer), or to apply custom filters.</span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">After Render Script</label>
        <div class="controls">
            <input id="camera_profile_on_after_render_script" name="on_after_render_script" type="text" class="input-xlg ignore_hidden_errors" data-bind="value: on_after_render_script" />
            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#after-render-script" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
            <div class="error_label_container text-error" data-error-for="camera_profile_on_after_render_script"></div>
            <span class="help-inline">Octolapse will execute any script path entered here after rendering is complete.</span>
        </div>
    </div>
    <hr/>
    <div>
        <h4>Custom Image Preferences</h4>
        <div data-bind="visible: camera_type()=='webcam'">
            <p>Here you can adjust brightness, contrast, focus, pan, tilt, etc. for your webcam.  If enabled, these preferences are applied at the start of each print.</p>
            <p>It is highly recommended that you take the time to configure these settings since they can make a big difference in the quality of your timelapse, and reduce the required snapshot delay.</p>
        </div>
        <div class="text-warning" data-bind="visible: camera_type()!='webcam'">
            <p>Custom image preferences are only available for webcams running on mjpegstreamer.  Consider using a custom 'Before Print Start Script' or try using a web camera running on mjpegstreamer.</p>
        </div>

    </div>
    <div data-bind="visible: camera_type()=='webcam'">
        <div class="control-group">
            <div class="controls">
                <label class="checkbox">
                    <a href="#" data-bind="click: toggleApplySettingsAtStartup" id="camera_profile_apply_settings_at_startup"><i class="fa fa-no-shadow" data-bind="css: { 'fa-check-square': apply_settings_at_startup , 'fa-square-o': !apply_settings_at_startup() } "></i></a>
                    <span data-bind="click: toggleApplySettingsAtStartup">Enable And Apply Preferences at Startup</span>
                    <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#custom-image-preferences" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                </label>
                <label class="checkbox">
                    <a href="#" data-bind="click: toggleApplySettingsBeforePrint" id="camera_profile_apply_settings_before_print"><i class="fa fa-no-shadow" data-bind="css: { 'fa-check-square': apply_settings_before_print , 'fa-square-o': !apply_settings_before_print() } "></i></a>
                    <span data-bind="click: toggleApplySettingsBeforePrint">Enable And Apply Preferences Before Print</span>
                    <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#custom-image-preferences" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                </label>
                <p class="text-warning" data-bind="visible:is_testing_custom_image_preferences">Your camera is being tested to see if it supports custom image preferences.</p>
            </div>
        </div>
        <div data-bind="visible: camera_stream_visible">
            <div class="webcam_settings_preview">
                <img class="webcam_stream_preview" data-bind="streamLoading:{src: webcam_settings.stream_url, loading_selector: '#octolapse_camera_profile_stream_loading', error_selector: '#octolapse_camera_profile_stream_error'}" style="display:none;">
                <div id="octolapse_camera_profile_stream_error" class="alert webcam_stream_preview" style="display:none;">
                    Unable to load the webcam stream
                </div>
                <div id="octolapse_camera_profile_stream_loading" class="webcam_stream_preview" style="display:none;">
                    Unable to load the webcam stream
                </div>
            </div>
            <div data-bind="template:{name:'webcam-settings-template', data:webcam_settings}"></div>
        </div>

    </div>
    <hr />
    <div>
        <div class="control-group">
            <a href="#" class="muted" data-bind="toggleContent: { class: 'fa-caret-right fa-caret-down', container: '#camera-advanced.hide' }">
                <i class="fa fa-no-shadow fa-caret-right"></i> {{ _('Advanced Camera Options') }}
            </a>
        </div>
        <div id="camera-advanced" class="control-group hide">
            <div>
                <div>
                    <h4>Security</h4>
                </div>

                <div class="control-group">
                    <label class="control-label">Ignore SSL Errors</label>
                    <div class="controls">
                        <label class="checkbox">
                            <input type="checkbox" data-bind="checked: webcam_settings.ignore_ssl_error" />Enabled
                            <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#ignore-ssl-errors" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                        </label>
                        <span class="help-inline">
                            Ignore any SSL errors at the camera address.  <span class="label label-important">Attention</span>&nbsp;Using this option will solve SSL issues if you are trying to stream your camera over https, but could leave you open to man in the middle attacks.
                        </span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">User Name</label>
                    <div class="controls">
                        <input name="username" type="text" class="input" data-bind="value: webcam_settings.username" />
                        <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#user-name" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                        <span class="help-inline">
                            Enter a username to be sent with the camera snapshot request.  If you leave this blank, no sign-in credentials will be sent
                        </span>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">Password</label>
                    <div class="controls">
                        <!-- The text and password here are to prevent FF from auto filling my login credentials because it ignores autocomplete="off"-->
                        <input type="text" style="display:none" />
                        <input type="password" style="display:none" />
                        <input name="camera_profile_password" type="password" autocomplete="off" class="input" data-bind="value: webcam_settings.password" />
                        <a href="https://github.com/FormerLurker/Octolapse/wiki/Camera-Profiles#password" title="Get help with this setting." target="_blank" ><span class="fa fa-question-circle fa-lg"></span></a>
                        <span class="help-inline">
                            If required, enter a password to be sent with the camera snapshot request.  <span class="label label-important">Attention</span>&nbsp;Be sure you are using HTTPS when setting a password and that your camera URL is secure to keep your password secure!
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>
{% include "octolapse_webcam_settings.jinja2" %}
